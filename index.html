<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>FMI Checker - DEKAN UNLOCK</title>
  <link rel="icon" href="https://img.icons8.com/fluency/48/iphone-14-pro.png"/>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet"/>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>
  <script src="https://unpkg.com/@lottiefiles/lottie-player@latest/dist/lottie-player.js"></script>
  <style>
    :root{--p:#6366f1;--pd:#4f46e5;--s:#10b981;--d:#ef4444;--bg:#0f0f23;--c:rgba(255,255,255,.05);--t:#e2e8f0;--tl:#94a3b8;--b:rgba(255,255,255,.1)}
    *{margin:0;padding:0;box-sizing:border-box}
    body{background:linear-gradient(135deg,#0f0f23,#1a1a2e);color:var(--t);font-family:'Inter',sans-serif;min-height:100vh;display:flex;align-items:center;justify-content:center;padding:20px;background-image:radial-gradient(circle at 20% 80%,rgba(99,102,241,.15)0%,transparent 50%),radial-gradient(circle at 80% 20%,rgba(16,185,129,.15)0%,transparent 50%)}
    .box{max-width:500px;width:100%;background:var(--c);backdrop-filter:blur(16px);border-radius:24px;overflow:hidden;box-shadow:0 20px 40px rgba(0,0,0,.3);border:1px solid var(--b)}
    .head{text-align:center;padding:2rem 1.5rem 1.5rem;background:linear-gradient(135deg,rgba(99,102,241,.2),rgba(16,185,129,.1))}
    .logo{width:90px;height:90px;margin:0 auto 1rem}
    h1{font-size:1.8rem;font-weight:700;background:linear-gradient(90deg,#a5b4fc,#c4b5fd);-webkit-background-clip:text;-webkit-text-fill-color:transparent;margin-bottom:.5rem}
    .form{padding:2rem}
    .inp{position:relative;margin-bottom:1.5rem}
    .inp input{width:100%;padding:1rem 1rem 1rem 3rem;background:rgba(255,255,255,.08);border:1px solid var(--b);border-radius:16px;color:#fff;font-size:1rem;transition:all .3s}
    .inp input:focus{outline:none;border-color:var(--p);box-shadow:0 0 0 3px rgba(99,102,241,.2);transform:translateY(-2px)}
    .inp i{position:absolute;left:1rem;top:50%;transform:translateY(-50%);color:var(--tl)}
    .btn{width:100%;padding:1rem;background:linear-gradient(135deg,var(--p),var(--pd));color:#fff;border:none;border-radius:16px;font-weight:600;font-size:1.1rem;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:.5rem;transition:all .3s}
    .btn:hover{transform:translateY(-3px);box-shadow:0 10px 20px rgba(99,102,241,.4)}
    .loading,.error,.result{margin-top:1.5rem;padding:1.5rem;background:rgba(255,255,255,.05);border-radius:16px;display:none;text-align:center}
    .spinner{width:40px;height:40px;border:4px solid rgba(99,102,241,.2);border-top:4px solid var(--p);border-radius:50%;animation:s 1s linear infinite;margin:0 auto 1rem}
    @keyframes s{to{transform:rotate(360deg)}}
    .result-item{display:flex;justify-content:space-between;padding:.75rem 0;border-bottom:1px solid var(--b)}
    .result-item:last-child{border:none}
    .status-on{color:var(--d);font-weight:bold}
    .status-off{color:var(--s);font-weight:bold}
    .tags{display:flex;gap:.5rem;justify-content:center;flex-wrap:wrap;margin-top:1rem}
    .tag{background:rgba(99,102,241,.15);color:#a5b4fc;padding:.4rem .8rem;border-radius:50px;font-size:.8rem}
  </style>
</head>
<body>
  <div class="box">
    <div class="head">
      <lottie-player class="logo" src="https://assets5.lottiefiles.com/packages/lf20_kkflmtur.json" background="transparent" speed="1" loop autoplay></lottie-player>
      <h1>DEKAN UNLOCK</h1>
      <p>Free FMI ON / OFF Checker</p>
    </div>
    <div class="form">
      <div class="inp">
        <i class="fas fa-mobile-alt"></i>
        <input type="text" id="imei" placeholder="Enter IMEI or Serial" maxlength="20">
      </div>
      <button class="btn" onclick="checkFMI()">
        <i class="fas fa-search"></i> Check Now
      </button>

      <div class="loading" id="loading">
        <div class="spinner"></div>
        <p>Starting server & checking...</p>
      </div>
      <div class="error" id="error"></div>
      <div class="result" id="result">
        <div class="result-item"><span>Model</span><span id="model">-</span></div>
        <div class="result-item"><span>IMEI/SN</span><span id="sn">-</span></div>
        <div class="result-item"><span>Find My</span><span id="fmi">-</span></div>
      </div>
      <div class="tags">
        <div class="tag">Free</div>
        <div class="tag">Fast</div>
        <div class="tag">Secure</div>
      </div>
    </div>
  </div>

  <script>
    async function checkFMI() {
      const imei = document.getElementById('imei').value.trim();
      if (!/^[0-9a-zA-Z]{10,20}$/.test(imei)) return showError('Invalid IMEI');

      showLoading();
      try {
        // 1. إرسال طلب لبدء الخادم
        const start = await fetch('https://api.github.com/repos/' + location.hostname.split('.')[0] + '/' + (location.pathname.split('/')[1] || 'fmi-checker') + '/dispatches', {
          method: 'POST',
          headers: {
            'Accept': 'application/vnd.github.v3+json',
            'Authorization': 'Bearer ' + btoa(Math.random()).substring(0, 20), // dummy token (ignored)
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            event_type: 'start_server',
            client_payload: { imei }
          })
        });

        if (!start.ok) throw new Error('Failed to start server');

        // 2. استطلاع ngrok URL
        const ngrokUrl = await pollNgrokUrl();
        const result = await fetch(`${ngrokUrl}/check_fmi.php?imei=${imei}`).then(r => r.json());

        if (result.success) showResult(result.data);
        else showError(result.error || 'Check failed');
      } catch (e) {
        showError(e.message || 'Network error');
      }
    }

    async function pollNgrokUrl() {
      for (let i = 0; i < 25; i++) {
        await new Promise(r => setTimeout(r, 3000));
        try {
          const runs = await fetch('https://api.github.com/repos/' + location.hostname.split('.')[0] + '/' + (location.pathname.split('/')[1] || 'fmi-checker') + '/actions/runs?event=repository_dispatch&per_page=1').then(r => r.json());
          const run = runs.workflow_runs[0];
          if (run && run.status === 'in_progress') {
            const logs = await fetch(run.logs_url).then(r => r.text());
            const match = logs.match(/https:\/\/[a-z0-9]+\.ngrok\.io/);
            if (match) return match[0];
          }
        } catch {}
      }
      throw new Error('Server timeout');
    }

    function showResult(d) {
      document.getElementById('model').textContent = d.model || 'Unknown';
      document.getElementById('sn').textContent = d.imei;
      const f = document.getElementById('fmi');
      f.textContent = d.fmi_display || (d.fmi_status === 'ON' ? 'ON' : 'OFF');
      f.className = d.fmi_status === 'ON' ? 'status-on' : 'status-off';
      document.getElementById('result').style.display = 'block';
      hideLoading();
    }

    function showError(msg) {
      document.getElementById('error').textContent = msg;
      document.getElementById('error').style.display = 'block';
      hideLoading();
    }

    function showLoading() {
      document.getElementById('loading').style.display = 'block';
      document.getElementById('error').style.display = document.getElementById('result').style.display = 'none';
    }

    function hideLoading() {
      document.getElementById('loading').style.display = 'none';
    }

    document.getElementById('imei').addEventListener('keypress', e => {
      if (e.key === 'Enter') checkFMI();
    });
  </script>
</body>
</html>
